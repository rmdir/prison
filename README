mod_prison : FreeBSD only module for Apache 2.4 http server (and maybe 2.2) 

Unlike jail-patch, this module create an unique jail for all 
Apache childs. Main process still unjailed like with mod_unixd 
sothat you don't need anything except Documents inside the jail.

INSTALL

You need a FreeBSD version that supports libjail (> 7.2).
ldconfig -r | grep jail

Then you can do 

make install

You can specify apxs PATH when building

make APXS=/usr/local/httpd/bin/apxs install

You can enforce security settings via setting JAIL_PARANOID

make -DJAIL_PARANOID install

USAGE

Now you can set in global config :

1) JailDir : the directory we will be jailed on
DocumentRoot must be relative to this path so you must use httpd -T 
to start Apache. If JAIL_PARANOID is set at compile time, JailDir must
be owned by root and not be world or group writable.

2) JailIP : A single ipv4 or ipv6 string repersentation (default none).
Apache still bind everything specified in Listen. JaiIP is just used for 
script stuff like database connections. If JAIL_PARANOID is set you can't
use INADDR_ANY (0.0.0.0).

3) JailSecurity : None|ALL|IPC

NONE : security settings are inherit from the system.

ALL : 
- securelevel : 3
- enforce_statfs : 2
- allow.set_hostname : 0
- allow.raw_sockets : 0
- allow.chflags : 0
- allow.mount : 0
- allow.quotas : 0
- allow.socket_af : 0
- allow.sysvipc : 0

IPC : like all but allow.sysvipc is set.

4) JailCPU : the cpu set of the jail.
You can write cpusets like with cpuset(1) :
- a single cpu. Eg. 1
- a list of cpu. Eg 1,4,6
- a cpu range. Eg 8-10 means 8,9,10

EXAMPLE
# grep Jail conf/httpd.conf
JailDir /usr/local/httpd/htdocs
JailIP ::1
JailCPU 1
JailSecurity IPC
# ./bin/httpd -T
# jls jid name host.hostname ip4.addr ip6.addr path
158 plop_rmdir_fr plop.rmdir.fr - ::1 /usr/local/httpd/htdoc
# ps auxw -o jid | grep http 
root    56821   0.0  0.2  33632 4380 ??  Ss    2:29PM     0:00.17 ./httpd -T         0
root    56822   0.0  0.2  33632 4392 ??  S     2:29PM     0:00.22 ./httpd -T         0
joris   56823   0.0  0.3  49380 5224 ??  SJ    2:29PM     0:00.61 ./httpd -T       158
joris   56824   0.0  0.3  49380 5224 ??  SJ    2:29PM     0:00.60 ./httpd -T       158
joris   56825   0.0  0.3  49380 5224 ??  SJ    2:29PM     0:00.62 ./httpd -T       158
joris   56826   0.0  0.3  49380 5224 ??  SJ    2:29PM     0:00.70 ./httpd -T       158
joris   56827   0.0  0.3  49380 5224 ??  SJ    2:29PM     0:00.67 ./httpd -T       158
joris   56828   0.0  0.3  49380 5224 ??  SJ    2:29PM     0:00.70 ./httpd -T       158
joris   63943   0.0  0.1  18456 1812  1  S+    5:27PM     0:00.00 grep http          0
# sockstat -j 158
sockstat -j 158
USER     COMMAND    PID   FD PROTO  LOCAL ADDRESS         FOREIGN ADDRESS      
joris    httpd      56828 3  tcp4 6 *:8088                *:*
joris    httpd      56828 4  tcp4   *:*                   *:*
joris    httpd      56827 3  tcp4 6 *:8088                *:*
joris    httpd      56827 4  tcp4   *:*                   *:*
joris    httpd      56826 3  tcp4 6 *:8088                *:*
joris    httpd      56826 4  tcp4   *:*                   *:*
joris    httpd      56825 3  tcp4 6 *:8088                *:*
joris    httpd      56825 4  tcp4   *:*                   *:*
joris    httpd      56824 3  tcp4 6 *:8088                *:*
joris    httpd      56824 4  tcp4   *:*                   *:*
joris    httpd      56823 3  tcp4 6 *:8088                *:*
joris    httpd      56823 4  tcp4   *:*                   *:*
# cpuset -g -j 158
jail 158 mask: 1
# curl -i http://www.rmdir.fr:8088/sysctl.cgi
HTTP/1.1 200 OK
Date: Wed, 10 Oct 2012 16:24:38 GMT
Server: Apache/2.4.3 (Unix)
Transfer-Encoding: chunked
Content-Type: text/plain


security.jail.jailed: 1
security.jail.jail_max_af_ips: 255
security.jail.set_hostname_allowed: 0
security.jail.socket_unixiproute_only: 1
security.jail.sysvipc_allowed: 1
security.jail.allow_raw_sockets: 0
security.jail.chflags_allowed: 0
security.jail.mount_allowed: 0
security.jail.mount_devfs_allowed: 0
security.jail.mount_nullfs_allowed: 0
security.jail.mount_procfs_allowed: 0
security.jail.mount_zfs_allowed: 0
security.jail.enforce_statfs: 2
security.jail.devfs_ruleset: 0
security.jail.param.jid: 0
security.jail.param.parent: 0
security.jail.param.name: 256
security.jail.param.path: 1024
security.jail.param.securelevel: 0
security.jail.param.enforce_statfs: 0
security.jail.param.devfs_ruleset: 0
security.jail.param.persist: 0
security.jail.param.vnet: 0
security.jail.param.dying: 0
security.jail.param.children.cur: 0
security.jail.param.children.max: 0
security.jail.param.host.: 0
security.jail.param.host.hostname: 256
security.jail.param.host.domainname: 256
security.jail.param.host.hostuuid: 64
security.jail.param.host.hostid: 0
security.jail.param.cpuset.id: 0
security.jail.param.ip4.: 0
security.jail.param.ip4.saddrsel: 0
security.jail.param.ip6.: 0
security.jail.param.ip6.saddrsel: 0
security.jail.param.allow.set_hostname: 0
security.jail.param.allow.sysvipc: 0
security.jail.param.allow.raw_sockets: 0
security.jail.param.allow.chflags: 0
security.jail.param.allow.quotas: 0
security.jail.param.allow.socket_af: 0
security.jail.param.allow.mount.: 0
security.jail.param.allow.mount.devfs: 0
security.jail.param.allow.mount.nullfs: 0
security.jail.param.allow.mount.procfs: 0
security.jail.param.allow.mount.zfs: 0
kern.securelevel: 3



BUGS AND STATUS

This is a really alpha software. It brakes graceful restart (httpd -k graceful)
and conflict with unixd ChrootDirectory.

SEE ALSO

http://code.google.com/p/mod-jail/

